<form [formGroup]="form" class="order-form">
  <!-- Cabeçalho -->
  <div class="order-grid header">
    <div>Código</div>
    <div>Descrição</div>
    <div>Quantidade</div>
    <div>Unitário</div>
    <div>Total</div>
    <div>Ações</div>
  </div>

  <!-- Itens -->
  <div formArrayName="items">
    <div
      *ngFor="let item of itemsFormArray.controls; let i = index; trackBy: trackByIndex"
      [formGroupName]="i"
      class="order-grid row"
      (keydown.enter)="onEnterKey(i, $event)"
    >
      <!-- Código -->
      <div class="cell">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Código</mat-label>
          <input
            matInput
            formControlName="code"
            #rowInput
            type="number"
            placeholder="Ex: 121"
            (keydown)="blockInvalidKeys($event)"
            (input)="preventNegativeValue(itemsFormArray.at(i), $event)"
          />
          <mat-error
            *ngIf="item.get('code')?.touched && item.get('code')?.hasError('required')"
          >
            Código obrigatório.
          </mat-error>
          <mat-error
            *ngIf="item.get('code')?.touched && item.get('code')?.hasError('min')"
          >
            O código não pode ser negativo.
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Descrição -->
      <div class="cell">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Descrição</mat-label>
          <input
            matInput
            formControlName="description"
            placeholder="Descrição"
          />
          <mat-error
            *ngIf="item.get('description')?.touched && item.get('description')?.hasError('required')"
          >
            Descrição obrigatória.
          </mat-error>
          <mat-error
            *ngIf="item.get('description')?.touched && item.get('description')?.hasError('maxlength')"
          >
            Máximo de 100 caracteres.
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Quantidade -->
      <div class="cell">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Quantidade</mat-label>
          <input
            matInput
            formControlName="quantity"
            type="text"
            placeholder="Ex: 12"
            [appQuantityMask]="item.get('code')"
          />
          <mat-error
            *ngIf="item.get('quantity')?.touched && item.get('quantity')?.hasError('required')"
          >
            Quantidade obrigatória.
          </mat-error>
          <mat-error
            *ngIf="item.get('quantity')?.touched && item.get('quantity')?.hasError('min')"
          >
            Deve ser maior que zero.
          </mat-error>
          <mat-error
            *ngIf="item.get('quantity')?.touched && item.get('quantity')?.hasError('invalidPrecision')"
          >
            Inválida: até 3 decimais (ímpar) ou inteira (par).
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Unitário -->
      <div class="cell">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Unitário</mat-label>
          <input
            matInput
            formControlName="unitPrice"
            type="text"
            currencyMask
            [options]="currencyOptions"
            (focus)="onFocusCurrency($event)"
          />
          <mat-error
            *ngIf="item.get('unitPrice')?.touched && item.get('unitPrice')?.hasError('required')"
          >
            Valor unitário obrigatório.
          </mat-error>
          <mat-error
            *ngIf="item.get('unitPrice')?.touched && item.get('unitPrice')?.hasError('min')"
          >
            Deve ser maior que zero.
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Total -->
      <div class="cell">
        <mat-form-field appearance="outline" floatLabel="always">
          <mat-label>Total</mat-label>
          <input
            matInput
            formControlName="totalPrice"
            type="text"
            currencyMask
            [options]="currencyOptions"
            (focus)="onFocusCurrency($event)"
          />
          <mat-error
            *ngIf="item.get('totalPrice')?.touched && item.get('totalPrice')?.hasError('required')"
          >
            Valor total obrigatório.
          </mat-error>
          <mat-error
            *ngIf="item.get('totalPrice')?.touched && item.get('totalPrice')?.hasError('min')"
          >
            Deve ser maior que zero.
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Ações -->
      <div class="cell actions">
        <button type="button" (click)="removeItem(i)" class="delete-btn">
          <span class="material-icons">delete</span> Excluir
        </button>
      </div>
    </div>
  </div>

  <!-- Botões -->
  <div class="actions-row">
    <button mat-flat-button color="primary" type="button" (click)="addItem()">
      + Adicionar Item
    </button>

    <button
      mat-stroked-button
      color="accent"
      type="button"
      (click)="generateFakeItems()"
    >
      + Gerar 100 Itens
    </button>
  </div>
</form>
